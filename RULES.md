# Lode Runner (1983) - 역공학 규칙 명세

이 문서는 `game.js`를 실행 기준으로, 원작 문헌(Apple II/C64 매뉴얼 계열)과 대조한 역공학 정리본입니다.

## 1. 범위와 기준

- 구현 기준: `game.js` (이 저장소의 실제 동작)
- 원작 참고: Apple II/C64 매뉴얼/문서 텍스트
- 기준 시점: 2026-02-15

검증 등급:
- `A`: `game.js` 코드로 직접 확인
- `B`: 원작 매뉴얼/문서 텍스트로 확인
- `C`: 코드 주석/관찰 기반 추정(추가 검증 필요)

## 2. 시스템/월드 고정값 (`A`)

```javascript
BASE_TILE_SIZE = 24
LEVEL_WIDTH = 28
LEVEL_HEIGHT = 16
BASE_WIDTH = 672
BASE_HEIGHT = 384
tickRate = 1000 / 30
```

- 좌표계: 타일(정수 격자) + 엔티티(부동소수 위치)
- 맵 밖 조회: `SOLID`로 취급
- 모드: `classic`(150), `championship`(50)

## 3. 상태 머신 (`A`)

| 상태 | 값 | 진입 조건 | 이탈 조건 |
|---|---:|---|---|
| `TITLE` | 0 | 시작/타이틀 복귀 | `ENTER`로 시작 |
| `PLAYING` | 1 | 레벨 로드 후 플레이 | 일시정지/사망/클리어/교착 |
| `PAUSED` | 2 | `ENTER`/`ESC` | `ENTER`/`ESC` |
| `DYING` | 3 | 사망 판정 | `DEATH_DELAY_FRAMES` 후 재시작 또는 게임오버 |
| `LEVEL_COMPLETE` | 4 | 클리어 판정 | `LEVEL_COMPLETE_DELAY_FRAMES` 후 다음 레벨 |
| `GAME_OVER` | 5 | 목숨 0 | `ENTER` |
| `STUCK` | 6 | `checkStuck()` 확정 | `ENTER`/`R`(목숨 1 소모) |
| `EDITOR` | 7 | `E` 토글 | `E`/`ESC` |

## 4. 타일/엔티티 의미 (`A`)

| 값 | 타입 | 문자 | 의미 |
|---:|---|---|---|
| 0 | `EMPTY` | `.` | 빈 공간 |
| 1 | `BRICK` | `#` | 파기 가능 벽돌 |
| 2 | `SOLID` | `@` | 파기 불가 고체 |
| 3 | `LADDER` | `H` | 일반 사다리 |
| 4 | `BAR` | `-` | 매달림 바 |
| 5 | `TRAP` | `T` | false floor |
| 6 | `GOLD` | `$` | 금 |
| 7 | `ESCAPE_LADDER` | `E` | 탈출 사다리 |

엔티티 문자:
- `P`: 플레이어 시작
- `E`: 적 시작

## 5. 충돌/고체성 규칙 (`A`)

- 플레이어 막힘: `BRICK`, `SOLID`
- 적 막힘: `BRICK`, `SOLID`
- 사다리 판정: `LADDER`, `ESCAPE_LADDER`
- 바 판정: `BAR`
- 반경 상수:
`ENEMY_COLLISION_RADIUS = 0.6`, `TRAPPED_ENEMY_RADIUS = 0.8`
- 구멍에 갇힌 엔티티 머리 위는 발판 취급

## 6. 플레이어 규칙 (`A`)

- 점프 없음
- 낙하 데미지 없음
- 기본 속도 `PLAYER_SPEED = 0.14`
- 바 위 속도 `PLAYER_SPEED * 1.15`
- 사다리/바/지면/낙하 중일 때 좌우 이동 허용
- `DOWN`으로 바에서 자발적 하강 가능
- 바 자동잡기 2종:
  - 수평 이동 중 머리 위 바 접촉 시 스냅
  - 낙하 중 머리 위 바 접촉 시 스냅

`TRAP(T)` 상호작용:
- 플레이어는 1프레임 지연 후 관통
- 적은 지연 없이 즉시 관통

## 7. 파기(dig) 규칙 (`A`,`B`)

- 입력: `DIGL`, `DIGR`
- 대상: 플레이어 좌/우 대각선 아래 1칸
- 파기 가능: `BRICK`, `TRAP`
- 파기 불가 조건:
  - 대상 상부가 `LADDER`/`ESCAPE_LADDER`/`BAR`
  - 플레이어 옆칸이 고체
- 성공 시 타일 `EMPTY` + 구멍 타이머 시작

원작 문헌 일치점(`B`):
- 벽돌은 파고, 단단한 바닥은 못 팜
- 사다리/로프 바로 아래 벽돌은 못 팜

## 8. 구멍 수명/복구 (`A`,`B`)

상수(30fps):
- `HOLE_FILL_TIME = 210`
- `ENEMY_TRAPPED_TIME = 150`
- `ENEMY_TRAPPED_ESCAPE = 60`

동작:
- 구멍 타이머 만료 시 `BRICK`으로 복구
- 복구 시 적이 구멍 좌표면 적 사망(+75) 후 리스폰
- 복구 시 플레이어가 구멍 좌표면 플레이어 즉사

플레이어/적 갇힘:
- 적은 구멍에 갇힌 뒤 일정 시간 후 탈출 시도
- 플레이어는 구멍에서 기본적으로 못 올라옴
- 플레이어가 단일 폭 구멍에 갇힌 채 복구되면 사망

원작 문헌 일치점(`B`):
- 적은 구멍에서 탈출 가능
- 플레이어는 구멍에서 탈출 불가
- 복구 시 적은 죽고 상단에서 재등장

## 9. 금/탈출 규칙 (`A`,`B`)

플레이어:
- 금 획득 시 `+250`, 타일 제거
- `player.goldCount`는 최대 1 보유 상태로 관리
- 사망 시 보유 금 1개를 현재칸 또는 윗칸에 드롭 시도

적:
- `hasGold`(1개) 보유
- 금 위 통과 시 `5%` 확률 획득, 30프레임 쿨다운
- 보유 중 `2%` 확률 드롭(근접 상황 가중)
- 구멍에 빠질 때 금 보유 중이면 위칸 드롭 시도

탈출:
- 모든 금 수집(`goldCollected >= goldCount`) 시 탈출 사다리 활성화
- 활성 후 상단 도달 시 레벨 클리어

원작 문헌 일치점(`B`):
- 적이 금을 숨겨서 들 수 있음
- 눈에 보이는 금을 다 먹었는데 사다리가 안 뜨면 적 보유 금이 남은 상태

## 10. 탈출 사다리 생성 알고리즘 (`A`,`C`)

`game.js` 구현:
- 기존 사다리 열을 스캔해 상단에 가까운 열 최대 3개 선택
- 각 선택 열에 대해 `y=0`부터 이어지는 `ESCAPE_LADDER` 생성
- 사다리가 없으면 바 열을 대체 사용

주의(`C`):
- 원작은 레벨 데이터에 미리 숨겨진 탈출 사다리가 존재하는 구조가 일반적
- 현재 구현은 동적 생성 알고리즘이므로 원작과 구조적으로 다를 수 있음

## 11. 적 AI 규칙 (`A`,`C`)

- 기본 추적: 플레이어 방향(수평 우선), 사다리 가능 시 수직 추적
- 같은 열 상하 분리 시 주변 사다리 탐색 후 근접 사다리로 이동
- 바 위에서는 수평 이동 또는 하강 결정
- 지면/사다리/바/갇힘 머리 위 발판 규칙을 모두 공유
- 금 보유 + 상단부(`y<5`)에서 좌측 탈출 성향 가중

주의(`C`):
- 원작 적 AI의 정확한 내부 우선순위(프레임 단위)는 기종별 차이가 있어 추가 실측 필요

## 12. 충돌/사망 규칙 (`A`,`B`)

- 기본 사망: 적과 같은 레벨에서 근접 중첩
- 예외:
  - 적이 구멍에 갇힘 상태면 접촉 사망 제외
  - 플레이어가 적 머리 위 위치면 안전
- 특수:
  - 적이 금 보유 중 접촉하면 플레이어가 금 탈취(+250)하고 생존

원작 문헌 일치점(`B`):
- 갇힌 적 위를 잠시 발판처럼 이용 가능

## 13. 점수/목숨/레벨 진행 (`A`,`B`)

점수:
- 금 획득: `+250`
- 적 구멍 포획: `+75`
- 구멍 복구로 적 사망: `+75`
- 레벨 클리어: `+1500`

목숨/진행:
- 현재 구현 시작 목숨: `99`
- 클리어 시 목숨 `+1`
- 클래식 150레벨 완료 시:
  - 속도 `+15%` (최대 `2.0x`)
  - 레벨 1로 순환
  - 점수/목숨 초기화(`0`, `99`)

원작 문헌 기준(`B`):
- 시작 목숨 `5`
- 클리어 보너스/점수표는 동일 계열

## 14. 입력/조작 (`A`,`B`)

현재 구현 키:
- 이동: 화살표, `WASD`, `IJKL`
- 파기: `Z/X`, `U/O`, `F1/F2`
- 시작/재개: `ENTER`
- 일시정지: `ESC`
- 재시작(목숨 소모): `R`
- 교착 중단(목숨 소모): `Ctrl+A`
- 사운드 토글: `M`
- 모드 전환: `C`
- 에디터 토글: `E`
- 디버그 레벨: `Shift+N/P`

원작 문헌 확인(`B`):
- `IJKL`, `UO`, `CTRL-A`, `ESC/RunStop`, 속도 `+/-` 계열 존재

## 15. 데모/교착/에디터/안정성 (`A`)

- 무입력 900프레임(30초) 후 데모 시작
- 데모는 간단한 경로 탐색 + 위험 회피 + 교착 탈출 행동
- `checkStuck()`:
  - 초기 유예 90프레임
  - 30프레임 주기 BFS 도달 가능성 검사
  - 불능 사유 연속 확인 시 `STUCK`
- 런타임 검증:
  - 30프레임마다 상태 무결성 검사
  - 예외 발생 시 오버레이 표시

## 16. 원작 대비 차이 요약

| 항목 | 원작 문헌 경향 | 현재 구현 |
|---|---|---|
| 시작 목숨 | 5 | 99 |
| 탈출 사다리 | 레벨 내 숨김 구조가 일반적 | 수집 후 동적 생성 |
| 입력 | IJKL/UO 중심 | 현대 키 확장 |
| 교착 처리 | `CTRL-A` 수동 중단 | 수동 + 자동 교착 탐지 |
| 파기 타일 | diggable brick 중심 | `BRICK` + `TRAP` |
| 속도 루프 | 기종별 변형/옵션 존재 | 클래식 150 완료 시 강제 가속 루프 |

## 17. 규칙 프로파일 제안

아래는 구현 분기를 위한 권장 프로파일입니다.

| 항목 | `apple2_strict` | `c64_strict` | `modern`(현재 기본) |
|---|---|---|---|
| 시작 목숨 | 5 | 5 | 99 |
| 레벨 완료 | +1500, 다음 레벨 | +1500, 다음 레벨 | +1500, 다음 레벨(+클래식 150 이후 가속 루프) |
| 탈출 사다리 | 레벨 내 숨김 사다리 노출형(정적) | 레벨 내 숨김 사다리 노출형(정적) | 동적 생성(사다리/바 열 상위 1~3개) |
| 입력 기본 | `IJKL`/`UO` 중심 | `IJKL`/`UO` + `CTRL-A` | 화살표/`WASD`/`IJKL` + 확장키 |
| 교착 처리 | 수동 중단 위주 | `CTRL-A` 수동 중단 | 자동 `STUCK` 탐지 + 수동 중단 |
| 파기 가능 타일 | `BRICK` 우선(엄격) | `BRICK` 우선(엄격) | `BRICK` + `TRAP` |
| false floor | 플레이어 지연, 적 즉시(검증 필요) | 플레이어 지연, 적 즉시(검증 필요) | 플레이어 1프레임 지연, 적 즉시 |
| 적 금 로직 | 보유/드롭 원작 규칙 | 보유/드롭 원작 규칙 | 확률형(`5%`/`2%`) + 쿨다운 |
| 데모/에디터 | 비활성 | 비활성 | 활성 |

프로파일 적용 우선순위:
- `apple2_strict`: 원작 규칙 재현 정확도 우선(편의 기능 최소화)
- `c64_strict`: C64 조작/운영 감각 우선
- `modern`: 현재 저장소 플레이 편의성과 디버깅 생산성 우선

프로파일 전환 시 최소 변경 대상:
- 초기값: `lives`, `speedMultiplier`, 입력 매핑
- 규칙: 탈출 사다리 생성 방식(정적/동적), 파기 가능 타일
- 시스템: `checkStuck`, demo, editor on/off

## 18. 후속 역공학 TODO

- Apple II/C64 실기/에뮬레이터로 프레임 단위 실측:
  - 구멍 복구 프레임
  - 적 탈출 개시 프레임
  - false floor 관통 지연
- 레벨별 숨은 탈출 사다리 원데이터 확인:
  - 동적 생성 제거 가능성 평가

## 19. 출처

- C64 매뉴얼 텍스트(점수, 5목숨, `CTRL-A`, 구멍 규칙):
  - https://www.lemon64.com/doc/lode-runner/355
- Apple II 문서 텍스트(동일 규칙군, 조작, 점수표):
  - https://apple2games.com/wiki/Lode_Runner
- Apple II FAQ(파기 제약, 28x16, 조작 보강):
  - https://gamefaqs.gamespot.com/appleii/577310-lode-runner/faqs/7328
- C64-Wiki(점수/키 크로스체크):
  - https://www.c64-wiki.com/wiki/Lode_Runner
