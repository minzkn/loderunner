# Lode Runner (1983) - 게임 규칙/메카닉 명세

`game.js` 구현을 기준으로 한 동작 명세입니다.  
원작(Apple II/C64 계열) 참고 규칙은 문서 하단 출처와 함께 별도 표기했습니다.

## 1. 시스템 기준

- 해상도: `672 x 384` (`28 x 16` 타일, 타일 `24px`)
- 업데이트: 고정 `30fps` (`tickRate = 1000 / 30`)
- 타이밍: 프레임 카운트 기반
- 게임 모드:
`classic`(150레벨), `championship`(50레벨)

## 2. 상태값(State)

| 상태 | 값 | 의미 |
|------|----|------|
| `TITLE` | 0 | 타이틀 |
| `PLAYING` | 1 | 플레이 중 |
| `PAUSED` | 2 | 일시정지 |
| `DYING` | 3 | 사망 연출 |
| `LEVEL_COMPLETE` | 4 | 클리어 연출 |
| `GAME_OVER` | 5 | 게임 오버 |
| `STUCK` | 6 | 교착 오버레이 |
| `EDITOR` | 7 | 레벨 에디터 |

참고:
- `checkStuck()`는 플레이 중 주기적으로(저빈도) 하드락 상태를 검사합니다.
  현재는 `NO REACHABLE MOVES`(실이동 불가)일 때만 `STUCK`으로 전환합니다.
- 런타임 예외 발생 시 게임 루프를 중단하고 `RUNTIME ERROR` 오버레이를 표시합니다.
  개발 검증용으로 URL `?failfast=1`을 주면 예외를 즉시 throw 합니다.

## 3. 타일/레벨 포맷

| 값 | 타입 | 문자 | 설명 |
|----|------|------|------|
| 0 | `EMPTY` | `.` | 빈 공간 |
| 1 | `BRICK` | `#` | 벽돌(플레이어 기준 고체, 파기 가능) |
| 2 | `SOLID` | `@` | 단단한 블록(파기 불가) |
| 3 | `LADDER` | `H` | 사다리 |
| 4 | `BAR` | `-` | 바(매달림) |
| 5 | `TRAP` | `T` | False Floor |
| 6 | `GOLD` | `$` | 금 |
| 7 | `ESCAPE_LADDER` | `E` | 탈출 사다리(활성화 후 사용) |

엔티티 문자:
- `P`: 플레이어 시작 위치
- `E`: 적 시작 위치

## 4. 좌표/충돌 기준

- 맵 경계 밖 조회는 `SOLID` 취급.
- 플레이어 고체 판정: `BRICK`, `SOLID`만 막힘.
- 적 고체 판정: 이동 시 `BRICK`, `SOLID`를 통과하지 못함.
- 충돌 반경 상수:
`ENEMY_COLLISION_RADIUS = 0.6`,
`TRAPPED_ENEMY_RADIUS = 0.8`.

## 5. 플레이어 규칙 (상세)

- 점프 없음.
- 낙하 데미지 없음.
- 바 위 이동 시 속도 보정:
`PLAYER_SPEED * ROPE_SPEED_MULTIPLIER` (`1.15x`).
- 사다리 위/인접 시 상하 이동 가능.
- 바에서는 좌우/낙하 중심 이동.
- 구멍에 갇힌 적/플레이어의 머리 위를 발판처럼 밟을 수 있음.

### 5.1 False Floor(`T`) 상호작용

- 플레이어:
`T` 위에서 `1프레임` 지연 후 붕괴 취급(즉시 추락 아님).
- 적:
`T` 위에서 지연 없이 즉시 추락 판정.

### 5.2 파기(Dig) 규칙

- 입력: `DIGL`/`DIGR`.
- 유효 대상: 좌/우 대각선 아래 타일.
- 파기 가능 타일: `BRICK`, `TRAP`.
- 파기 시 해당 타일은 `EMPTY`가 되고 구멍 타이머 시작.

## 6. 금/탈출 규칙

- 금 획득 시:
`+250`, `goldCollected += 1`.
- 플레이어 운반 제한:
`player.goldCount` 최대 1.
- 모든 금(`goldCollected >= goldCount`) 수집 시 탈출 사다리 활성화.

### 6.1 탈출 사다리 생성 알고리즘

- 기존 사다리 열을 위쪽부터 검색해 접근성 높은 상위 열 최대 3개를 선택.
- 선택 열의 `y=0`부터 해당 사다리까지 `ESCAPE_LADDER` 생성.
- 사다리가 전혀 없으면 바(`BAR`) 열 기준으로 대체 생성.
- 클리어 판정:
`escapeLadderActive === true` 상태에서 `y=0` 탈출 사다리 타일 도달.

## 7. 적(가드) 규칙 (상세)

- 사다리/바 사용 가능.
- 플레이어 추적형 AI:
수직 정렬 시 사다리 탐색 우선, 아니면 수평 추적.
- 금 보유:
`hasGold` 1개 상태 관리.
- 금 획득 확률:
`GOLD_PICKUP_CHANCE = 0.05` (쿨다운 30프레임).
- 금 드롭 확률:
`GOLD_DROP_CHANCE = 0.02` (근접 상황 가중 로직 포함).

### 7.1 구멍 상호작용

- 적이 구멍에 빠지면 `ENEMY_TRAPPED_TIME` 동안 고정.
- 잔여 시간이 `ENEMY_TRAPPED_ESCAPE` 미만이면 탈출 시도.
- 구멍 복구 시점에 적이 구멍 안이면 사망 처리 후 리스폰.
- 리스폰 위치:
화면 상단 3줄 내 비고체 타일 랜덤.

## 8. 구멍 수명/복구

- 구멍 생성 타이머:
`HOLE_FILL_TIME = 210` (30fps 약 7초).
- 복구 직전 시각 효과:
점멸/부분 복구 렌더링.
- 복구 순간:
`BRICK`으로 환원.
- 복구 타일에 플레이어가 있으면 즉사.

## 9. 충돌/사망/리스폰

- 기본: 적과 같은 높이에서 겹치면 플레이어 사망.
- 예외:
플레이어가 적 머리 위 위치면 안전.
- 예외 2:
적이 구멍에 갇힌 상태면 접촉 사망 판정 제외.
- 적이 금 보유 상태에서 접촉 시:
플레이어는 사망 대신 금 탈취(+250, 수집 카운트 증가).

플레이어 사망 시:
- `DYING` 진입, `lives--`.
- `player.goldCount > 0`이면 현재/윗칸에 금 드롭 시도.
- 사망 연출 후 목숨이 남아 있으면 현재 레벨 재로드.

## 10. 점수/목숨/진행

| 이벤트 | 점수 |
|--------|------|
| 금 획득 | `+250` |
| 적 구멍 포획 | `+75` |
| 구멍 복구로 적 사망 | `+75` |
| 레벨 클리어 | `+1500` |

목숨/레벨:
- 시작 목숨: `99`
- 레벨 클리어 시:
`currentLevel++`, `lives++`, `+1500`.
- 단, 클래식 150레벨 완료 시 특수 루프:
속도 `+15%`(최대 `2.0x`), 레벨 1로 복귀, `score=0`, `lives=99`.

## 11. 타이밍 상수 (30fps)

| 항목 | 값 | 설명 |
|------|----|------|
| `HOLE_FILL_TIME` | 210 | 구멍 복구 |
| `ENEMY_TRAPPED_TIME` | 150 | 적 갇힘 |
| `ENEMY_TRAPPED_ESCAPE` | 60 | 적 탈출 시도 시작 |
| `DEATH_DELAY_FRAMES` | 45 | 사망 연출 |
| `LEVEL_COMPLETE_DELAY_FRAMES` | 60 | 클리어 대기 |
| `GOLD_PICKUP_COOLDOWN` | 30 | 적 금 획득 쿨다운 |
| `idleTimeoutFrames` | 900 | 무입력 데모 전환(30초) |

60fps 환산 참고:
- `HOLE_FILL_TIME`: 420
- `ENEMY_TRAPPED_TIME`: 300

## 12. 조작

- 이동:
방향키, `A/W/S/D`, `I/J/K/L`
- 파기:
`Z/X`, `U/O`, `F1/F2`
- 시작/일시정지 토글:
`ENTER`
- 일시정지:
`ESC`
- 레벨 재시작(목숨 1 소모):
`R`
- 교착 중단(목숨 1 소모):
`Ctrl+A`
- 사운드 토글:
`M`
- 모드 전환(타이틀):
`C`
- 에디터 토글:
`E`
- 디버그 레벨 이동:
`Shift+N`, `Shift+P`

## 13. 에디터/데모

에디터:
- 타일 선택 `1~8`
- 저장 `S`, 로드 `L`
- 플레이어 배치 `P`, 적 배치 `E`
- 마우스 클릭으로 타일 배치

데모:
- `30초` 무입력 시 자동 시작
- 데모 중 `ENTER` 입력 시 타이틀로 복귀
- 데모 사망/클리어 시 랜덤 저레벨 재시작 로직 포함

## 14. 원작 대비 현재 구현 차이 (명시)

| 항목 | 원작 문헌 경향 | 현재 구현 |
|------|----------------|-----------|
| 시작 목숨 | 5(문헌 다수) | 99 |
| 레벨 종료 후 보상 | +1500, 다음 레벨 | 동일 + 클래식 150 완료 시 속도 루프/점수·목숨 리셋 |
| 교착 해결 | 원작은 수동 자살/중단 키 존재 | `Ctrl+A` 중단 키 + 자동 `checkStuck()` 하드락 판정 |
| 조작 체계 | IJKL/UO 중심 | 방향키, WASD, IJKL, Z/X, U/O, F1/F2 확장 |
| 파기 대상 | 일반적으로 diggable brick | `BRICK` + `TRAP` 파기 허용 |

## 15. 원작 규칙 검증 매트릭스 (심화 검색 반영)

아래 표는 원작 문헌 규칙을 `game.js` 구현과 대조한 결과입니다.

| 규칙 항목 | 원작 문헌 근거 | 현재 구현 | 판정 |
|-----------|----------------|-----------|------|
| 승리 조건 | 금을 모두 모은 뒤(숨겨진 사다리 활성), 맵 상단 도달 시 클리어 | `goldCollected >= goldCount` 후 탈출 사다리 활성, `y=0` 도달 시 클리어 | 일치 |
| 점프 가능 여부 | 점프 불가 | 점프 입력/로직 없음 | 일치 |
| 낙하 피해 | 높은 곳에서 떨어져도 피해 없음 | 낙하 데미지 없음 | 일치 |
| 파기 방향 | 좌/우 대각선 아래만 파기 | `DIGL`/`DIGR`로 대각선 아래 파기 | 일치 |
| 파기 제약 | 사다리/바 바로 아래 벽돌은 파기 불가(원작 규칙) | 파기 가능 타일이더라도 상부 사다리/바 존재 시 파기 차단 | 일치 |
| 적의 금 운반 | 적은 금 1개를 들 수 있고, 구멍에 빠지면 금을 떨어뜨릴 수 있음 | `hasGold` 불리언(실질 1개 운반) + 구멍/확률 드롭 | 대체로 일치 |
| 구멍 복구와 적 처리 | 구멍이 메워질 때 적은 소멸 후 상단에서 재등장 | 복구 시 적 사망 처리 + 상단 3줄 랜덤 리스폰 | 일치 |
| 기본 점수표 | 금 `250`, 적 포획 `75`, 구멍으로 적 제거 `75`, 레벨 완료 `1500` | 동일 | 일치 |
| 시작 목숨 | 기본 `5` | `99` | 차이 |
| 교착 탈출 키 | `CTRL-A`로 현재 맵 중단(stuck abort) | `Ctrl+A`로 현재 시도 중단(목숨 1 소모) | 일치 |

### 15.1 원작 규칙 보강 포인트 (규칙 우선순위)

원작 재현 우선 시, 아래 항목은 후속 적용 대상으로 둡니다.

1. 목숨 기본값 정렬:
기본값 `99`를 개발용 옵션으로 분리하고, 원작 기본값 `5`를 기본 프리셋으로 제공.
2. 기종별 규칙 프로파일 분리:
`Apple II`, `C64`, `Modern(현재)` 프리셋으로 입력/세부 규칙 차이를 명시.

## 16. 출처

1. C64 매뉴얼 아카이브 (점수, 목숨, 적 금 드롭, 구멍 복구, 교착 중단 키)  
https://www.lemon64.com/doc/lode-runner/355
2. Apple II FAQ/매뉴얼 요약 (숨겨진 사다리, 점프 불가, 낙하 무피해, 파기 제약)  
https://gamefaqs.gamespot.com/appleii/577310-lode-runner/faqs/7328
3. C64-Wiki 항목 (기종/버전 맥락, 보조 교차 확인)  
https://www.c64-wiki.com/wiki/Lode_Runner

주의:
- 원작은 Apple II, C64, 아케이드, 콘솔 이식판 간 입력과 세부 규칙 차이가 존재합니다.
- 이 저장소의 실행 기준은 항상 `game.js`이며, 외부 문헌은 규칙 근거와 차이 분석 용도로 사용합니다.
